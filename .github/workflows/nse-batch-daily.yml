name: NSE Daily Batch Analysis

on:
  schedule:
    # Run at 2:45 PM IST (9:15 AM UTC) on weekdays only
    - cron: '15 9 * * 1-5'
  workflow_dispatch: # Allow manual trigger for testing

env:
  RUST_LOG: info
  CARGO_TERM_COLOR: always

jobs:
  nse-batch-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Kill entire job after 10 minutes
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Cache Cargo registry
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
          
    - name: Build NSE Analyzer
      run: cargo build --release
      
    - name: Run NSE Batch Analysis
      timeout-minutes: 3  # Kill this step after 2 minutes (120 seconds)
      run: |
        # Set environment for batch mode only
        export NSE_MODE=batch
        
        # Run the batch analysis
        ./target/release/nse-analyzer
        
        # Create summary data for email body (not as file)
        if [ -f "batch_rules.json" ]; then
          echo "ANALYSIS_SUCCESS=true" >> $GITHUB_ENV
          
          # Count total alerts and securities
          ALERT_COUNT=$(jq '[.[].alerts | length] | add // 0' batch_rules.json)
          SECURITY_COUNT=$(jq 'length' batch_rules.json)
          
          echo "ALERT_COUNT=$ALERT_COUNT" >> $GITHUB_ENV
          echo "SECURITY_COUNT=$SECURITY_COUNT" >> $GITHUB_ENV
          
          # Get securities with alerts (names)
          SECURITIES_WITH_ALERTS=$(jq -r '.[].symbol' batch_rules.json | tr '\n' ', ' | sed 's/,$//')
          echo "SECURITIES_WITH_ALERTS=$SECURITIES_WITH_ALERTS" >> $GITHUB_ENV
          
          # Create alert type breakdown with security names
          echo "Creating alert breakdown table..."
          
          # Get unique alert types
          jq -r '[.[].alerts[].alert_type] | unique | .[]' batch_rules.json > /tmp/alert_types.txt
          
          # Create table data for each alert type
          echo "ALERT_TABLE_DATA<<EOF" >> $GITHUB_ENV
          while IFS= read -r alert_type; do
            if [ ! -z "$alert_type" ]; then
              securities=$(jq -r --arg type "$alert_type" '.[] | select(.alerts[]?.alert_type == $type) | .symbol' batch_rules.json | sort | uniq | tr '\n' ',' | sed 's/,$//')
              count=$(jq -r --arg type "$alert_type" '[.[].alerts[] | select(.alert_type == $type)] | length' batch_rules.json)
              echo "${alert_type}|${count}|${securities}"
            fi
          done < /tmp/alert_types.txt
          echo "EOF" >> $GITHUB_ENV
          
        else
          echo "ANALYSIS_SUCCESS=false" >> $GITHUB_ENV
          echo "ALERT_COUNT=0" >> $GITHUB_ENV
          echo "SECURITY_COUNT=0" >> $GITHUB_ENV
          echo "SECURITIES_WITH_ALERTS=None" >> $GITHUB_ENV
          echo "ALERT_TABLE_DATA=" >> $GITHUB_ENV
        fi
        
    - name: Archive analysis results
      if: env.ANALYSIS_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: nse-batch-rules-${{ github.run_number }}
        path: batch_rules.json
        retention-days: 30
        
    - name: Format Alert Table
      id: format-table
      if: env.ANALYSIS_SUCCESS == 'true'
      run: |
        # Format the alert table data into readable format
        formatted_table=""
        if [ ! -z "${{ env.ALERT_TABLE_DATA }}" ]; then
          while IFS='|' read -r alert_type count securities; do
            if [ ! -z "$alert_type" ]; then
              # Truncate long security lists for readability
              if [ ${#securities} -gt 30 ]; then
                securities_display="${securities:0:27}..."
              else
                securities_display="$securities"
              fi
              
              # Format the table row
              printf "%-25s | %-5s | %-30s\n" "$alert_type" "$count" "$securities_display" >> /tmp/formatted_table.txt
            fi
          done <<< "${{ env.ALERT_TABLE_DATA }}"
          
          # Read the formatted table
          formatted_table=$(cat /tmp/formatted_table.txt)
        else
          formatted_table="No alerts generated"
        fi
        
        # Set output for use in email
        echo "formatted_table<<EOF" >> $GITHUB_OUTPUT
        echo "$formatted_table" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Generate IST Timestamp
      run: |
        IST_TIME=$(TZ="Asia/Kolkata" date +"%d %b %y %H:%M")
        echo "IST_TIMESTAMP=$IST_TIME" >> $GITHUB_ENV

    - name: Send email notification
      if: always()  # Send email even if analysis fails
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_PASSWORD }}
        subject: "NSE Analysis Report - ${{ env.IST_TIMESTAMP }} (${{ env.ANALYSIS_SUCCESS == 'true' && 'SUCCESS' || 'FAILED' }})"
        to: ${{ secrets.EMAIL_RECIPIENT }}
        from: ${{ secrets.GMAIL_USERNAME }}
        body: |
          NSE Daily Analysis Report
          =============================================
          
          üìä SUMMARY
          ‚Ä¢ Securities with alerts: ${{ env.SECURITY_COUNT || '0' }}
          ‚Ä¢ Total alerts generated: ${{ env.ALERT_COUNT || '0' }}
          ‚Ä¢ Status: ${{ env.ANALYSIS_SUCCESS == 'true' && '‚úÖ Completed Successfully' || '‚ùå Failed/Timeout' }}
          
          üè¢ SECURITIES WITH ALERTS
          ${{ env.SECURITIES_WITH_ALERTS || 'None' }}
          
          üìà ALERT BREAKDOWN TABLE
          ========================
          ${{ env.ANALYSIS_SUCCESS == 'true' && steps.format-table.outputs.formatted_table || 'No data available - analysis failed or timed out.' }}
          
          ‚ÑπÔ∏è  TROUBLESHOOTING (if failed)
          ‚Ä¢ NSE API timeout (90 second limit)
          ‚Ä¢ Network connectivity issues  
          ‚Ä¢ NSE server problems
          ‚Ä¢ Market hours/trading session status
          
          üîó ADDITIONAL INFO
          ‚Ä¢ Run ID: ${{ github.run_number }}
          ‚Ä¢ Repository: ${{ github.repository }}
          ‚Ä¢ Full artifacts: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ‚Ä¢ Generated at: ${{ env.IST_TIMESTAMP }}
        attachments: batch_rules.json
        
    - name: Notification on failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_PASSWORD }}
        subject: "üö® NSE Analysis FAILED - ${{ env.IST_TIMESTAMP }}"
        to: ${{ secrets.EMAIL_RECIPIENT }}
        from: ${{ secrets.GMAIL_USERNAME }}
        body: |
          ‚ö†Ô∏è NSE Daily Analysis Failed
          
          Run ID: ${{ github.run_number }}
          Repository: ${{ github.repository }}
          Generated at: ${{ env.IST_TIMESTAMP }}
          
          Please check the logs at:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Error details may be available in the workflow logs.